apiVersion: v1
kind: ConfigMap
metadata:
  name: localstack-init
data:
  init-aws.sh: |
    #!/bin/bash
    set -euo pipefail

    echo "Initializing LocalStack AWS resources..."

    REGION="us-east-1"

    # DynamoDB table
    awslocal dynamodb create-table \
      --table-name incident_items \
      --attribute-definitions \
        AttributeName=PK,AttributeType=S \
        AttributeName=SK,AttributeType=S \
        AttributeName=Status,AttributeType=S \
        AttributeName=CreatedAt,AttributeType=S \
      --key-schema \
        AttributeName=PK,KeyType=HASH \
        AttributeName=SK,KeyType=RANGE \
      --global-secondary-indexes \
        '[{
          "IndexName": "StatusCreatedAtIndex",
          "KeySchema": [
            {"AttributeName": "Status", "KeyType": "HASH"},
            {"AttributeName": "CreatedAt", "KeyType": "RANGE"}
          ],
          "Projection": {"ProjectionType": "ALL"}
        }]' \
      --billing-mode PAY_PER_REQUEST \
      --region "$REGION"

    echo "Created DynamoDB table: incident_items"

    # S3 bucket
    awslocal s3 mb s3://public-safety-lab-evidence-dev --region "$REGION"

    awslocal s3api put-bucket-cors \
      --bucket public-safety-lab-evidence-dev \
      --cors-configuration '{
        "CORSRules": [{
          "AllowedHeaders": ["*"],
          "AllowedMethods": ["GET", "PUT", "POST"],
          "AllowedOrigins": ["http://localhost:4200"],
          "ExposeHeaders": ["ETag"]
        }]
      }'

    echo "Created S3 bucket: public-safety-lab-evidence-dev"

    # SQS queues
    awslocal sqs create-queue \
      --queue-name incident-events-dev-dlq \
      --region "$REGION"

    awslocal sqs create-queue \
      --queue-name incident-events-dev \
      --attributes '{
        "VisibilityTimeout": "60",
        "RedrivePolicy": "{\"deadLetterTargetArn\":\"arn:aws:sqs:us-east-1:000000000000:incident-events-dev-dlq\",\"maxReceiveCount\":\"5\"}"
      }' \
      --region "$REGION"

    echo "Created SQS queues: incident-events-dev, incident-events-dev-dlq"
    echo "LocalStack initialization complete."
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: localstack
  labels:
    app: localstack
spec:
  replicas: 1
  selector:
    matchLabels:
      app: localstack
  template:
    metadata:
      labels:
        app: localstack
    spec:
      containers:
        - name: localstack
          image: localstack/localstack:latest
          ports:
            - containerPort: 4566
          env:
            - name: SERVICES
              value: s3,sqs,dynamodb
            - name: DEBUG
              value: "0"
          volumeMounts:
            - name: init-script
              mountPath: /etc/localstack/init/ready.d/init-aws.sh
              subPath: init-aws.sh
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: "1"
              memory: 1Gi
          readinessProbe:
            httpGet:
              path: /_localstack/health
              port: 4566
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: init-script
          configMap:
            name: localstack-init
            defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: localstack
spec:
  selector:
    app: localstack
  ports:
    - port: 4566
      targetPort: 4566
